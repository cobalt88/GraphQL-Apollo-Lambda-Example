"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.startServerAndCreateLambdaHandler = void 0;
function startServerAndCreateLambdaHandler(server, handler, options) {
    server.startInBackgroundHandlingStartupErrorsByLoggingAndFailingAllRequests();
    const defaultContext = async () => ({});
    const contextFunction = options?.context ?? defaultContext;
    return async function (event, context) {
        const resultMiddlewareFns = [];
        try {
            for (const middlewareFn of options?.middleware ?? []) {
                const resultCallback = await middlewareFn(event);
                if (resultCallback) {
                    resultMiddlewareFns.push(resultCallback);
                }
            }
            const httpGraphQLRequest = handler.fromEvent(event);
            const response = await server.executeHTTPGraphQLRequest({
                httpGraphQLRequest,
                context: () => contextFunction({ event, context }),
            });
            const result = handler.toSuccessResult(response);
            for (const resultMiddlewareFn of resultMiddlewareFns) {
                await resultMiddlewareFn(result);
            }
            return result;
        }
        catch (e) {
            const result = handler.toErrorResult(e);
            for (const resultMiddlewareFn of resultMiddlewareFns) {
                await resultMiddlewareFn(result);
            }
            return result;
        }
    };
}
exports.startServerAndCreateLambdaHandler = startServerAndCreateLambdaHandler;
//# sourceMappingURL=lambdaHandler.js.map